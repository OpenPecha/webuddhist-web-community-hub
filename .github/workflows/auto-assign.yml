on:
  issues:
    types: [opened]

jobs:
  add_metadata_and_format:
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to project and set status
        uses: actions/add-to-project@v1.0.1
        with:
          project-url: https://github.com/orgs/OpenPecha/projects/128
          github-token: ${{ secrets.PROJECT_MANAGEMENT_TOKEN }}

      - name: Format Userback Issue Body
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_MANAGEMENT_TOKEN }}
          script: |
            // 1. Fetch the current issue data
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // 2. Function to clean Userback HTML and Apply Template
            function processIssueBody(body) {
              if (!body) return "";
              
              // First, standard cleanup (HTML to text fixes)
              let content = body
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/&quot;/g, '"')
                .replace(/&#039;/g, "'")
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>');

              // Define the Userback header pattern
              // Matches: **Name** added a feedback(#ID) from URL
              const userbackHeaderRegex = /^\*\*.*?\*\* added a feedback.*?from https:\/\/.*?(?:\n|$)/i;

              // Check if this looks like a Userback issue
              if (userbackHeaderRegex.test(content)) {
                // Remove the header
                content = content.replace(userbackHeaderRegex, '').trim();

                // Define the new template
                const template = `**1. User story:**
            As a ........
            I need .........
            In order to .......

            **2. Definition of Done(DoD)**
                 - [ ] 
                 - [ ] 
                 - [ ] 

            ---
            **Original Feedback:**
            `;

                // Prepend template to the remaining content
                return template + content;
              }

              // If it's not a Userback header, just return the cleaned text
              return content;
            }

            // 3. Update issue if content exists and changes are needed
            if (issue.body) {
              const newBody = processIssueBody(issue.body);
              
              // Only make an API call if formatting actually changed something
              if (newBody !== issue.body) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: newBody
                });
                console.log("Issue body formatted with template.");
              }
            }
